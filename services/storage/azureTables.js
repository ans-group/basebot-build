'use strict';Object.defineProperty(exports, "__esModule", { value: true });var _azureStorage = require('azure-storage');var _azureStorage2 = _interopRequireDefault(_azureStorage);
var _util = require('util');
var _logger = require('../logger');var _logger2 = _interopRequireDefault(_logger);function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}

const debug = (0, _logger2.default)('services:storage:azureTables', 'debug');
const error = (0, _logger2.default)('services:storage:azureTables', 'error');

const tablePrefix = (process.env.BOT_NAME || 'basebot').replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
const teamsRef = `${tablePrefix}Teams`;
const usersRef = `${tablePrefix}Users`;
const channelsRef = `${tablePrefix}Channels`;

const driver = {
  teams: {
    get: get(teamsRef),
    save: save(teamsRef),
    all: all(teamsRef) },

  channels: {
    get: get(channelsRef),
    save: save(channelsRef),
    all: all(channelsRef) },

  users: {
    get: get(usersRef),
    save: save(usersRef),
    all: all(usersRef) } };exports.default =



driver;

const tableService = _azureStorage2.default.createTableService(process.env.DB_URL);
const entGen = _azureStorage2.default.TableUtilities.entityGenerator;

// promisifiy all the things
const createTableIfNotExists = (0, _util.promisify)(tableService.createTableIfNotExists).bind(tableService);
const retrieveEntity = (0, _util.promisify)(tableService.retrieveEntity).bind(tableService);
const insertOrMergeEntity = (0, _util.promisify)(tableService.insertOrMergeEntity).bind(tableService);
const queryEntities = (0, _util.promisify)(tableService.queryEntities).bind(tableService);

function get(table) {
  return id => new Promise(async (resolve, reject) => {
    debug(`attempting to fetch document with ID: ${id}`);
    try {
      await createTableIfNotExists(table);
      const { Data } = await retrieveEntity(table, 'partition', id);
      const data = JSON.parse(Data['_']);
      debug(`document retrieved:`, data);
      resolve(data);
    } catch (err) {
      error(err);
      resolve(null);
    }
  });
}

function save(table) {
  return data => new Promise(async (resolve, reject) => {
    debug('saving: ', data);
    try {
      await createTableIfNotExists(table);
      let existingData = {};
      try {
        const { Data } = await retrieveEntity(table, 'partition', data.id);
        existingData = Data && JSON.parse(Data['_']) ? JSON.parse(Data['_']) : {};
      } catch (err) {
        error(new Error(err));
      }
      await insertOrMergeEntity(table, {
        PartitionKey: entGen.String('partition'),
        RowKey: entGen.String(data.id),
        Data: entGen.String(JSON.stringify(Object.assign({}, existingData, data))) });

      resolve();
    } catch (err) {
      error(new Error(err));
      reject(err);
    }
  });
}

function all(table) {
  return () => new Promise(async (resolve, reject) => {
    debug(`fetching all records in: ${table}`);
    try {
      await createTableIfNotExists(table);
      const { entries } = await queryEntities(table, new _azureStorage2.default.TableQuery(), null);
      const data = Object.keys(entries).map(key => JSON.parse(entries[key].Data['_']));
      resolve(data);
    } catch (err) {
      error(err);
      reject(err);
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZpY2VzL3N0b3JhZ2UvYXp1cmVUYWJsZXMuanMiXSwibmFtZXMiOlsiZGVidWciLCJlcnJvciIsInRhYmxlUHJlZml4IiwicHJvY2VzcyIsImVudiIsIkJPVF9OQU1FIiwicmVwbGFjZSIsInRvTG93ZXJDYXNlIiwidGVhbXNSZWYiLCJ1c2Vyc1JlZiIsImNoYW5uZWxzUmVmIiwiZHJpdmVyIiwidGVhbXMiLCJnZXQiLCJzYXZlIiwiYWxsIiwiY2hhbm5lbHMiLCJ1c2VycyIsInRhYmxlU2VydmljZSIsImF6dXJlIiwiY3JlYXRlVGFibGVTZXJ2aWNlIiwiREJfVVJMIiwiZW50R2VuIiwiVGFibGVVdGlsaXRpZXMiLCJlbnRpdHlHZW5lcmF0b3IiLCJjcmVhdGVUYWJsZUlmTm90RXhpc3RzIiwiYmluZCIsInJldHJpZXZlRW50aXR5IiwiaW5zZXJ0T3JNZXJnZUVudGl0eSIsInF1ZXJ5RW50aXRpZXMiLCJ0YWJsZSIsImlkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJEYXRhIiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsImVyciIsImV4aXN0aW5nRGF0YSIsIkVycm9yIiwiUGFydGl0aW9uS2V5IiwiU3RyaW5nIiwiUm93S2V5Iiwic3RyaW5naWZ5IiwiT2JqZWN0IiwiYXNzaWduIiwiZW50cmllcyIsIlRhYmxlUXVlcnkiLCJrZXlzIiwibWFwIiwia2V5Il0sIm1hcHBpbmdzIjoiMkVBQUEsNkM7QUFDQTtBQUNBLG1DOztBQUVBLE1BQU1BLFFBQVEsc0JBQU8sOEJBQVAsRUFBdUMsT0FBdkMsQ0FBZDtBQUNBLE1BQU1DLFFBQVEsc0JBQU8sOEJBQVAsRUFBdUMsT0FBdkMsQ0FBZDs7QUFFQSxNQUFNQyxjQUFjLENBQUNDLFFBQVFDLEdBQVIsQ0FBWUMsUUFBWixJQUF3QixTQUF6QixFQUFvQ0MsT0FBcEMsQ0FBNEMsZUFBNUMsRUFBNkQsRUFBN0QsRUFBaUVDLFdBQWpFLEVBQXBCO0FBQ0EsTUFBTUMsV0FBWSxHQUFFTixX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LGdCQUFRdEIsT0FBT3FCLE1BQVAsQ0FBY1AsS0FBS0wsRUFBbkIsQ0FGdUI7QUFHL0JJLGNBQU1iLE9BQU9xQixNQUFQLENBQWNOLEtBQUtRLFNBQUwsQ0FBZUMsT0FBT0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JQLFlBQWxCLEVBQWdDSixJQUFoQyxDQUFmLENBQWQsQ0FIeUIsRUFBM0IsQ0FBTjs7QUFLQUg7QUFDRCxLQWZELENBZUUsT0FBT00sR0FBUCxFQUFZO0FBQ1p0QyxZQUFNLElBQUl3QyxLQUFKLENBQVVGLEdBQVYsQ0FBTjtBQUNBTCxhQUFPSyxHQUFQO0FBQ0Q7QUFDRixHQXJCYyxDQUFmO0FBc0JEOztBQUVELFNBQVN4QixHQUFULENBQWNlLEtBQWQsRUFBcUI7QUFDbkIsU0FBTyxNQUFNLElBQUlFLE9BQUosQ0FBWSxPQUFPQyxPQUFQLEVBQWdCQyxNQUFoQixLQUEyQjtBQUNsRGxDLFVBQU8sNEJBQTJCOEIsS0FBTSxFQUF4QztBQUNBLFFBQUk7QUFDRixZQUFNTCx1QkFBdUJLLEtBQXZCLENBQU47QUFDQSxZQUFNLEVBQUVrQixPQUFGLEtBQWMsTUFBTW5CLGNBQWNDLEtBQWQsRUFBcUIsSUFBSVgsdUJBQU04QixVQUFWLEVBQXJCLEVBQTZDLElBQTdDLENBQTFCO0FBQ0EsWUFBTWIsT0FBT1UsT0FBT0ksSUFBUCxDQUFZRixPQUFaLEVBQXFCRyxHQUFyQixDQUF5QkMsT0FBT2YsS0FBS0MsS0FBTCxDQUFXVSxRQUFRSSxHQUFSLEVBQWFqQixJQUFiLENBQWtCLEdBQWxCLENBQVgsQ0FBaEMsQ0FBYjtBQUNBRixjQUFRRyxJQUFSO0FBQ0QsS0FMRCxDQUtFLE9BQU9HLEdBQVAsRUFBWTtBQUNadEMsWUFBTXNDLEdBQU47QUFDQUwsYUFBT0ssR0FBUDtBQUNEO0FBQ0YsR0FYWSxDQUFiO0FBWUQiLCJmaWxlIjoiYXp1cmVUYWJsZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXp1cmUgZnJvbSAnYXp1cmUtc3RvcmFnZSdcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ3V0aWwnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcidcblxuY29uc3QgZGVidWcgPSBsb2dnZXIoJ3NlcnZpY2VzOnN0b3JhZ2U6YXp1cmVUYWJsZXMnLCAnZGVidWcnKVxuY29uc3QgZXJyb3IgPSBsb2dnZXIoJ3NlcnZpY2VzOnN0b3JhZ2U6YXp1cmVUYWJsZXMnLCAnZXJyb3InKVxuXG5jb25zdCB0YWJsZVByZWZpeCA9IChwcm9jZXNzLmVudi5CT1RfTkFNRSB8fCAnYmFzZWJvdCcpLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnJykudG9Mb3dlckNhc2UoKVxuY29uc3QgdGVhbXNSZWYgPSBgJHt0YWJsZVByZWZpeH1UZWFtc2BcbmNvbnN0IHVzZXJzUmVmID0gYCR7dGFibGVQcmVmaXh9VXNlcnNgXG5jb25zdCBjaGFubmVsc1JlZiA9IGAke3RhYmxlUHJlZml4fUNoYW5uZWxzYFxuXG5jb25zdCBkcml2ZXIgPSB7XG4gIHRlYW1zOiB7XG4gICAgZ2V0OiBnZXQodGVhbXNSZWYpLFxuICAgIHNhdmU6IHNhdmUodGVhbXNSZWYpLFxuICAgIGFsbDogYWxsKHRlYW1zUmVmKVxuICB9LFxuICBjaGFubmVsczoge1xuICAgIGdldDogZ2V0KGNoYW5uZWxzUmVmKSxcbiAgICBzYXZlOiBzYXZlKGNoYW5uZWxzUmVmKSxcbiAgICBhbGw6IGFsbChjaGFubmVsc1JlZilcbiAgfSxcbiAgdXNlcnM6IHtcbiAgICBnZXQ6IGdldCh1c2Vyc1JlZiksXG4gICAgc2F2ZTogc2F2ZSh1c2Vyc1JlZiksXG4gICAgYWxsOiBhbGwodXNlcnNSZWYpXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZHJpdmVyXG5cbmNvbnN0IHRhYmxlU2VydmljZSA9IGF6dXJlLmNyZWF0ZVRhYmxlU2VydmljZShwcm9jZXNzLmVudi5EQl9VUkwpXG5jb25zdCBlbnRHZW4gPSBhenVyZS5UYWJsZVV0aWxpdGllcy5lbnRpdHlHZW5lcmF0b3JcblxuLy8gcHJvbWlzaWZpeSBhbGwgdGhlIHRoaW5nc1xuY29uc3QgY3JlYXRlVGFibGVJZk5vdEV4aXN0cyA9IHByb21pc2lmeSh0YWJsZVNlcnZpY2UuY3JlYXRlVGFibGVJZk5vdEV4aXN0cykuYmluZCh0YWJsZVNlcnZpY2UpXG5jb25zdCByZXRyaWV2ZUVudGl0eSA9IHByb21pc2lmeSh0YWJsZVNlcnZpY2UucmV0cmlldmVFbnRpdHkpLmJpbmQodGFibGVTZXJ2aWNlKVxuY29uc3QgaW5zZXJ0T3JNZXJnZUVudGl0eSA9IHByb21pc2lmeSh0YWJsZVNlcnZpY2UuaW5zZXJ0T3JNZXJnZUVudGl0eSkuYmluZCh0YWJsZVNlcnZpY2UpXG5jb25zdCBxdWVyeUVudGl0aWVzID0gcHJvbWlzaWZ5KHRhYmxlU2VydmljZS5xdWVyeUVudGl0aWVzKS5iaW5kKHRhYmxlU2VydmljZSlcblxuZnVuY3Rpb24gZ2V0ICh0YWJsZSkge1xuICByZXR1cm4gaWQgPT4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGRlYnVnKGBhdHRlbXB0aW5nIHRvIGZldGNoIGRvY3VtZW50IHdpdGggSUQ6ICR7aWR9YClcbiAgICB0cnkge1xuICAgICAgYXdhaXQgY3JlYXRlVGFibGVJZk5vdEV4aXN0cyh0YWJsZSlcbiAgICAgIGNvbnN0IHsgRGF0YSB9ID0gYXdhaXQgcmV0cmlldmVFbnRpdHkodGFibGUsICdwYXJ0aXRpb24nLCBpZClcbiAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKERhdGFbJ18nXSlcbiAgICAgIGRlYnVnKGBkb2N1bWVudCByZXRyaWV2ZWQ6YCwgZGF0YSlcbiAgICAgIHJlc29sdmUoZGF0YSlcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGVycm9yKGVycilcbiAgICAgIHJlc29sdmUobnVsbClcbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIHNhdmUgKHRhYmxlKSB7XG4gIHJldHVybiBkYXRhID0+IG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBkZWJ1Zygnc2F2aW5nOiAnLCBkYXRhKVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjcmVhdGVUYWJsZUlmTm90RXhpc3RzKHRhYmxlKVxuICAgICAgbGV0IGV4aXN0aW5nRGF0YSA9IHt9XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7IERhdGEgfSA9IGF3YWl0IHJldHJpZXZlRW50aXR5KHRhYmxlLCAncGFydGl0aW9uJywgZGF0YS5pZClcbiAgICAgICAgZXhpc3RpbmdEYXRhID0gRGF0YSAmJiBKU09OLnBhcnNlKERhdGFbJ18nXSkgPyBKU09OLnBhcnNlKERhdGFbJ18nXSkgOiB7fVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGVycm9yKG5ldyBFcnJvcihlcnIpKVxuICAgICAgfVxuICAgICAgYXdhaXQgaW5zZXJ0T3JNZXJnZUVudGl0eSh0YWJsZSwge1xuICAgICAgICBQYXJ0aXRpb25LZXk6IGVudEdlbi5TdHJpbmcoJ3BhcnRpdGlvbicpLFxuICAgICAgICBSb3dLZXk6IGVudEdlbi5TdHJpbmcoZGF0YS5pZCksXG4gICAgICAgIERhdGE6IGVudEdlbi5TdHJpbmcoSlNPTi5zdHJpbmdpZnkoT2JqZWN0LmFzc2lnbih7fSwgZXhpc3RpbmdEYXRhLCBkYXRhKSkpXG4gICAgICB9KVxuICAgICAgcmVzb2x2ZSgpXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBlcnJvcihuZXcgRXJyb3IoZXJyKSlcbiAgICAgIHJlamVjdChlcnIpXG4gICAgfVxuICB9KVxufVxuXG5mdW5jdGlvbiBhbGwgKHRhYmxlKSB7XG4gIHJldHVybiAoKSA9PiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgZGVidWcoYGZldGNoaW5nIGFsbCByZWNvcmRzIGluOiAke3RhYmxlfWApXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGNyZWF0ZVRhYmxlSWZOb3RFeGlzdHModGFibGUpXG4gICAgICBjb25zdCB7IGVudHJpZXMgfSA9IGF3YWl0IHF1ZXJ5RW50aXRpZXModGFibGUsIG5ldyBhenVyZS5UYWJsZVF1ZXJ5KCksIG51bGwpXG4gICAgICBjb25zdCBkYXRhID0gT2JqZWN0LmtleXMoZW50cmllcykubWFwKGtleSA9PiBKU09OLnBhcnNlKGVudHJpZXNba2V5XS5EYXRhWydfJ10pKVxuICAgICAgcmVzb2x2ZShkYXRhKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZXJyb3IoZXJyKVxuICAgICAgcmVqZWN0KGVycilcbiAgICB9XG4gIH0pXG59XG4iXX0=